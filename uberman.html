// FILE: js/uberman.js
import { supabase } from "./supabaseClient.js";

document.addEventListener("DOMContentLoaded", () => {
  // Elements
  const countdownEl = document.getElementById("countdown");
  const dayEl = document.getElementById("day");
  const hoursEl = document.getElementById("hours");
  const notesEl = document.getElementById("notes");
  const controlsEl = document.getElementById("controls");
  const settingsEl = document.getElementById("settings");

  const incrementBtn = document.getElementById("incrementBtn");
  const saveBtn = document.getElementById("saveBtn");
  const resetBtn = document.getElementById("resetBtn");
  const lockBtn = document.getElementById("lockBtn");
  const backBtn = document.getElementById("backBtn");
  const startBtn = document.getElementById("startBtn");
  const startTimeInput = document.getElementById("startTime");

  const avgBtn = document.getElementById("avgBtn");
  const avgModal = document.getElementById("avgModal");
  const avgClose = avgModal.querySelector(".close");
  const avgText = document.getElementById("avgText");

  let counter = null;
  let unlocked = false;

  // Load or create counter
  async function loadCounter() {
    const { data, error } = await supabase
      .from("uberman_counters")
      .select("*")
      .limit(1)
      .maybeSingle();

    if (error) return console.error("Load error:", error);

    if (!data) {
      const { data: created, error: createError } = await supabase
        .from("uberman_counters")
        .insert({ day: 0, current_awake_hours: 0 })
        .select()
        .single();
      if (createError) return console.error("Create error:", createError);
      counter = created;
    } else counter = data;

    render();
  }

  function render() {
    if (!counter) return;
    dayEl.textContent = `Day: ${counter.day ?? 0}`;
    hoursEl.textContent = `Awake: ${counter.current_awake_hours ?? 0}h / Asleep: 0h`; // placeholder asleep
    notesEl.textContent = "Compared to an average person, you areâ€¦"; // can expand later
  }

  // Increment awake hours
  async function incrementHour() {
    if (!counter) return;
    counter.current_awake_hours = Number(counter.current_awake_hours || 0) + 1;

    const { error } = await supabase
      .from("uberman_counters")
      .update({ current_awake_hours: counter.current_awake_hours, last_update: new Date() })
      .eq("id", counter.id);
    if (error) return console.error("Update error:", error);

    render();
  }

  // Save counter
  async function saveCounter() {
    if (!counter) return;
    const { error } = await supabase
      .from("uberman_counters")
      .update({ current_awake_hours: counter.current_awake_hours })
      .eq("id", counter.id);
    if (error) return console.error("Save error:", error);
    alert("Counter saved!");
  }

  // Reset counter
  async function resetCounter() {
    if (!counter) return;
    if (!confirm("Reset counter?")) return;
    counter.current_awake_hours = 0;
    counter.day = 0;
    const { error } = await supabase
      .from("uberman_counters")
      .update({ current_awake_hours: 0, day: 0 })
      .eq("id", counter.id);
    if (error) return console.error("Reset error:", error);
    render();
  }

  // Lock/unlock controls
  function toggleLock() {
    unlocked = !unlocked;
    controlsEl.style.display = unlocked ? "flex" : "none";
    settingsEl.style.display = unlocked ? "flex" : "none";
    lockBtn.textContent = unlocked ? "Lock Settings" : "Unlock Settings";
  }

  // Show average modal
  function showAvg() {
    avgText.innerHTML = `
      Average person sleeps ~56h/week, 240h/month, 2920h/year.
      Uberman is ~2h sleep/day. Lifespan comparison depends on adherence.
    `;
    avgModal.style.display = "block";
  }

  // Close modal
  avgClose.onclick = () => avgModal.style.display = "none";
  window.onclick = (e) => { if (e.target === avgModal) avgModal.style.display = "none"; }

  // Event listeners
  incrementBtn.addEventListener("click", incrementHour);
  saveBtn.addEventListener("click", saveCounter);
  resetBtn.addEventListener("click", resetCounter);
  lockBtn.addEventListener("click", toggleLock);
  backBtn.addEventListener("click", () => window.history.back());
  startBtn.addEventListener("click", () => {
    if (!startTimeInput.value) return alert("Select start time");
    alert("Start time set for: " + startTimeInput.value);
  });
  avgBtn.addEventListener("click", showAvg);

  // Init
  loadCounter();
});
